package com.minhasfinancas

import android.Manifest
import android.os.Build
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.result.contract.ActivityResultContracts
import com.minhasfinancas.assistant.AndroidBridgeBootstrap
import com.minhasfinancas.assistant.LambdaSessionSource
import com.minhasfinancas.assistant.SupabaseSessionTokenProvider
import com.minhasfinancas.voice.AndroidSpeechInput
import com.minhasfinancas.voice.AndroidTtsOutput
import com.minhasfinancas.voice.AssistantVoiceScreen
import com.minhasfinancas.voice.AssistantVoiceViewModel

class MainActivity : ComponentActivity() {

    private val requestMicPermission = registerForActivityResult(
        ActivityResultContracts.RequestPermission(),
    ) { /* tratar feedback se necessário */ }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        requestMicrophoneIfNeeded()

        val tokenProvider = SupabaseSessionTokenProvider(
            sessionSource = LambdaSessionSource {
                // TODO: Substitua pela leitura real da sessão Supabase do seu app Android
                // Exemplo: supabaseClient.auth.currentSessionOrNull()?.accessToken
                null
            },
        )

        val repository = AndroidBridgeBootstrap.createRepository(
            baseUrl = "https://<PROJECT_REF>.supabase.co/",
            tokenProvider = tokenProvider,
            deviceIdProvider = { "android-${Build.MODEL}" },
        )

        val speechInput = AndroidSpeechInput(context = this)
        val speechOutput = AndroidTtsOutput(context = this)

        val orchestrator = AndroidBridgeBootstrap.createVoiceOrchestrator(
            repository = repository,
            speechInput = speechInput,
            speechOutput = speechOutput,
        )

        val viewModel = AssistantVoiceViewModel(orchestrator)

        setContent {
            AssistantVoiceScreen(viewModel = viewModel)
        }
    }

    private fun requestMicrophoneIfNeeded() {
        requestMicPermission.launch(Manifest.permission.RECORD_AUDIO)
    }
}
